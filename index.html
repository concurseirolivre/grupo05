<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulação ATS - START FIX</title>
<style>
:root{ --bg:#050202; --warn:#ffb86b; --text:#dcdcdc; --accent:#66ffcc; }
html,body{height:100%;margin:0;background:var(--bg);font-family:"Courier New",monospace;color:var(--text);overflow:hidden;}
.background-fixed{position:fixed;inset:0;background:#000 url('retro-bg.jpg') center/cover no-repeat;filter:brightness(.25);z-index:-10;}
.crt-overlay{position:fixed;inset:0;pointer-events:none;mix-blend-mode:overlay;z-index:1200;background-image: linear-gradient(rgba(0,0,0,0) 49%, rgba(0,0,0,0.05) 50%, rgba(0,0,0,0) 51%);background-size:100% 4px;}
.app{display:flex;align-items:center;justify-content:center;height:100vh;padding:24px;box-sizing:border-box;}
.center-card{width:92%;max-width:1100px;min-height:540px;background:linear-gradient(180deg,#0a0a0a,#050505);border-radius:10px;padding:18px;box-shadow:0 12px 60px rgba(0,0,0,0.8);position:relative;overflow:hidden;}
.header{display:flex;justify-content:space-between;align-items:center;color:#bbb;margin-bottom:8px;}
.hud-pill{background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:999px;}
.content{display:flex;gap:14px;}
.panel{flex:1.6;background:rgba(255,255,255,0.02);padding:14px;border-radius:6px;min-height:380px;}
.panel-right{flex:.9;background:rgba(255,255,255,0.01);padding:12px;border-radius:6px;}
.choices{margin-top:12px;display:flex;flex-direction:column;gap:10px;}
.choice-btn{background:transparent;border:2px solid rgba(255,255,255,0.06);padding:12px;border-radius:8px;color:var(--text);cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.choice-btn:hover{transform:translateX(6px);border-color:rgba(255,255,255,0.12);}
.crisis-meter{height:28px;background:rgba(255,255,255,0.03);border-radius:6px;overflow:hidden;}
.crisis-fill{height:100%;width:10%;background:linear-gradient(90deg,#66ff88,#ffcc00,#ff6666);transition:width .6s;}
.timeline{margin-top:10px;background:rgba(0,0,0,0.15);padding:8px;border-radius:6px;max-height:160px;overflow:auto;color:#ccc;}
/* start overlay */
#start-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.75),rgba(0,0,0,0.9));z-index:2200;}
.start-box{width:520px;max-width:92%;background:#090909;padding:28px;border-radius:8px;text-align:center;border:1px solid rgba(255,255,255,0.03);}
#btn-start{margin-top:18px;padding:14px 28px;font-size:1.2rem;border-radius:8px;border:none;cursor:pointer;background:linear-gradient(90deg,#ff6b6b,#ffcc66);color:#031010;font-weight:800;box-shadow:0 8px 24px rgba(255,120,80,0.12);transition:transform .12s;}
#btn-start:active{transform:translateY(2px) scale(.995);}
#btn-start[aria-busy="true"]{opacity:.7;transform:scale(.98);pointer-events:none;}
.msg-small{color:#cfcfcf;margin-top:8px;font-size:.95rem;}
</style>
</head>
<body>
  <div class="background-fixed" aria-hidden="true"></div>
  <div class="crt-overlay" aria-hidden="true"></div>

  <!-- START OVERLAY -->
  <div id="start-overlay" role="dialog" aria-modal="true" aria-label="Iniciar Simulação">
    <div class="start-box">
      <h1 style="margin:0;color:var(--warn);letter-spacing:2px">INICIAR SIMULAÇÃO</h1>
      <p class="msg-small">Modo: Gerenciamento de crise. Use 1/2/3 para escolher rapidamente após iniciar.</p>
      <button id="btn-start" aria-label="Iniciar simulação" tabindex="0">► INICIAR</button>
      <div id="start-feedback" class="msg-small" aria-live="polite"></div>
    </div>
  </div>

  <div class="app" role="application" aria-hidden="false">
    <div class="center-card" role="region" aria-label="Simulação">
      <div class="header">
        <div><span class="hud-pill">SALA DE SITUAÇÃO</span></div>
        <div style="display:flex;gap:10px;"><div class="hud-pill">Hora: <strong id="sim-time">06:05</strong></div><div class="hud-pill">Equipes: <strong id="teams">10</strong></div></div>
      </div>

      <div class="content">
        <div class="panel">
          <h3 id="scene-title" style="margin:0 0 8px 0;color:var(--warn)">COORDENAÇÃO MÉDICA</h3>
          <div id="story-text" style="white-space:pre-wrap;color:#e6e6e6;min-height:160px">A simulação aguarda início.</div>
          <div class="choices" id="choices-container"></div>
        </div>

        <aside class="panel-right">
          <h4 style="margin:0 0 8px 0;color:#8fffd3">PAINEL</h4>
          <div class="small-muted">Crisis Meter</div>
          <div class="crisis-meter" id="crisis-meter" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="10"><div id="crisis-fill" class="crisis-fill" style="width:10%"></div></div>
          <div style="margin-top:10px" class="timeline" id="timeline"></div>
        </aside>
      </div>
    </div>
  </div>

  <!-- audios (substitua caminhos) -->
  <audio id="sfx-alert" src="sfx_alert.mp3" preload="auto"></audio>
  <audio id="bg-ambience" src="bg_ambience_loop.mp3" preload="auto" loop></audio>

<script>
/* Wrap everything after DOM/load to avoid null refs */
window.addEventListener('load', () => {
  const btnStart = document.getElementById('btn-start');
  const startOverlay = document.getElementById('start-overlay');
  const startFeedback = document.getElementById('start-feedback');
  const storyText = document.getElementById('story-text');
  const choicesContainer = document.getElementById('choices-container');
  const simTimeEl = document.getElementById('sim-time');
  const teamsEl = document.getElementById('teams');
  const crisisFill = document.getElementById('crisis-fill');
  const timelineEl = document.getElementById('timeline');
  const sfxAlert = document.getElementById('sfx-alert');
  const bgAmb = document.getElementById('bg-ambience');

  let started = false;
  let teams = 10;
  let crisis = 10;
  let simTime = 6*60 + 5;
  let eventInterval = null;

  function logTimeline(msg){
    const node = document.createElement('div');
    node.textContent = `${formatTime(simTime)} — ${msg}`;
    timelineEl.prepend(node);
  }
  function formatTime(mins){ const h = Math.floor(mins/60).toString().padStart(2,'0'); const m = (mins%60).toString().padStart(2,'0'); return `${h}:${m}`; }

  function updateCrisis(){
    crisisFill.style.width = Math.max(0,Math.min(100,crisis)) + '%';
    document.getElementById('crisis-meter').setAttribute('aria-valuenow', crisis);
    if(crisis>70){ sfxAlert.currentTime=0; sfxAlert.play().catch(()=>{}); }
  }

  /* scene/choices (simplified) */
  const scenes = {
    start: {
      title: 'COORDENAÇÃO MÉDICA',
      text: "[06:05] Alerta: Deslizamento. Você é o Coordenador. Priorize recursos.",
      choices: [
        { text: '1 - Enviar 6 equipes para Zona de Impacto', action: ()=> allocate(6,'impact') },
        { text: '2 - Manter gestão centralizada (4 em campo)', action: ()=> allocate(4,'balanced') },
        { text: '3 - Prevenção: avaliar abrigos', action: ()=> allocate(3,'prevention') }
      ]
    },
    mid: {
      title: 'ESCALADA',
      text: "[12:00] Eventos agrícolas. Decida: comunicações, logística ou clínica.",
      choices: [
        { text: '1 - Restaurar comunicações', action: ()=> { logTimeline('Comunicações restauradas'); crisis -= 5; updateCrisis(); render('mid'); } },
        { text: '2 - Priorizar logística', action: ()=> { logTimeline('Logística reforçada'); crisis -= 7; updateCrisis(); render('mid'); } },
        { text: '3 - Enviar equipes clínicas', action: ()=> { logTimeline('Equipes clínicas enviadas'); crisis += 3; updateCrisis(); render('mid'); } }
      ]
    },
    debrief: {
      title: 'DEBRIEF',
      text: "Debrief: revisão de decisões e explicação clínica (síndrome do esmagamento, CO etc.)",
      choices: [
        { text: 'R - Reiniciar', action: ()=> resetSim() }
      ]
    }
  };

  function render(key){
    const sc = scenes[key];
    if(!sc) return;
    document.getElementById('scene-title').textContent = sc.title;
    storyText.textContent = sc.text;
    choicesContainer.innerHTML = '';
    sc.choices.forEach((c, idx) => {
      const b = document.createElement('button');
      b.className = 'choice-btn';
      b.innerHTML = `<span>${c.text}</span><span style="opacity:.6">[Enter]</span>`;
      b.onclick = () => c.action();
      b.onkeydown = (e) => { if(e.key==='Enter' || e.key===' ') c.action(); };
      choicesContainer.appendChild(b);
    });
  }

  function allocate(n, mode){
    teams = Math.max(0, teams - n);
    teamsEl.textContent = teams;
    if(mode==='impact'){ crisis -= 8; updateCrisis(); logTimeline(`Enviou ${n} equipes p/ impacto`); setTimeout(()=>{ crisis += 10; updateCrisis(); logTimeline('Consequência: abrigos sem atenção'); render('mid'); }, 3000); }
    else if(mode==='balanced'){ crisis -= 3; updateCrisis(); logTimeline('Gestão equilibrada'); render('mid'); }
    else { crisis -= 6; updateCrisis(); logTimeline('Foco em prevenção'); render('mid'); }
  }

  function startEventLoop(){
    if(eventInterval) clearInterval(eventInterval);
    eventInterval = setInterval(()=> {
      const r = Math.random();
      if(r < 0.12){ crisis += 12; updateCrisis(); logTimeline('Evento: chuva intensa'); }
      else if(r < 0.30){ crisis += 6; updateCrisis(); logTimeline('Evento: estrada bloqueada'); }
      else if(r < 0.45){ crisis -= 4; updateCrisis(); logTimeline('Boa: doações chegaram'); }
    }, 8000);
  }

  function resetSim(){
    teams = 10; teamsEl.textContent = teams;
    crisis = 10; updateCrisis();
    simTime = 6*60 + 5; simTimeEl.textContent = formatTime(simTime);
    timelineEl.innerHTML = '';
    render('start');
    logTimeline('Simulação reiniciada');
  }

  /* --- Start button handler robusto --- */
  function onStartClicked(){
    console.log('Start button clicked - handler running');
    startFeedback.textContent = 'Iniciando...';
    btnStart.setAttribute('aria-busy','true');
    // small delay to show feedback
    setTimeout(()=> {
      try{
        started = true;
        startOverlay.style.display = 'none';
        // start ambience (may be blocked - ignore errors)
        bgAmb.volume = 0.12;
        bgAmb.play().catch((e)=> console.warn('bgAmbience play blocked',e));
        // start event loop and first render
        startEventLoop();
        resetSim();
        // keyboard quick actions: 1/2/3
        window.addEventListener('keydown', (e) => {
          if(!started) return;
          if(e.key==='1') document.querySelectorAll('.choice-btn')[0]?.click();
          if(e.key==='2') document.querySelectorAll('.choice-btn')[1]?.click();
          if(e.key==='3') document.querySelectorAll('.choice-btn')[2]?.click();
        });
      } catch(err){
        console.error('Erro ao iniciar simulação:', err);
        startFeedback.textContent = 'Erro ao iniciar — veja Console (F12).';
        btnStart.removeAttribute('aria-busy');
      }
    }, 220);
  }

  // attach click and keyboard handlers to start button (robust)
  btnStart.addEventListener('click', onStartClicked);
  btnStart.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onStartClicked(); } });

  // safety: if button not clickable (rare cases), add global handler
  document.addEventListener('click', (e) => {
    // if clicked the overlay but not the button, ignore
    if(!started && e.target === startOverlay) {
      startFeedback.textContent = 'Clique em INICIAR para começar';
    }
  });

  // initial render (waiting)
  resetSim(); // renders scene but doesn't start event loop until click

  console.log('Simulação pronta. Pressione INICIAR.');
});
</script>
</body>
</html>
